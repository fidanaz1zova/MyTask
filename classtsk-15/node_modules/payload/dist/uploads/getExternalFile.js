"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "getExternalFile", {
    enumerable: true,
    get: function() {
        return getExternalFile;
    }
});
const _errors = require("../errors");
function _getRequireWildcardCache(nodeInterop) {
    if (typeof WeakMap !== "function") return null;
    var cacheBabelInterop = new WeakMap();
    var cacheNodeInterop = new WeakMap();
    return (_getRequireWildcardCache = function(nodeInterop) {
        return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
    })(nodeInterop);
}
function _interop_require_wildcard(obj, nodeInterop) {
    if (!nodeInterop && obj && obj.__esModule) {
        return obj;
    }
    if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
        return {
            default: obj
        };
    }
    var cache = _getRequireWildcardCache(nodeInterop);
    if (cache && cache.has(obj)) {
        return cache.get(obj);
    }
    var newObj = {
        __proto__: null
    };
    var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;
    for(var key in obj){
        if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
            var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;
            if (desc && (desc.get || desc.set)) {
                Object.defineProperty(newObj, key, desc);
            } else {
                newObj[key] = obj[key];
            }
        }
    }
    newObj.default = obj;
    if (cache) {
        cache.set(obj, newObj);
    }
    return newObj;
}
const getExternalFile = async ({ data, req, uploadConfig })=>{
    const { filename, url } = data;
    if (typeof url === 'string') {
        let fileURL = url;
        if (!url.startsWith('http')) {
            const baseUrl = req.get('origin') || `${req.protocol}://${req.get('host')}`;
            fileURL = `${baseUrl}${url}`;
        }
        const { default: fetch } = await Promise.resolve().then(()=>/*#__PURE__*/ _interop_require_wildcard(require("node-fetch")));
        const headers = uploadConfig.externalFileHeaderFilter ? uploadConfig.externalFileHeaderFilter(headersToObject(req.headers)) : {
            cookie: req.headers['cookie']
        };
        const res = await fetch(fileURL, {
            credentials: 'include',
            headers,
            method: 'GET'
        });
        if (!res.ok) throw new _errors.APIError(`Failed to fetch file from ${fileURL}`, res.status);
        const data = await res.buffer();
        return {
            name: filename,
            data,
            mimetype: res.headers.get('content-type') || undefined,
            size: Number(res.headers.get('content-length')) || 0
        };
    }
    throw new _errors.APIError('Invalid file url', 400);
};
function headersToObject(headers) {
    return Object.entries(headers).reduce((acc, [key, value])=>{
        if (Array.isArray(value)) {
            acc[key] = value.join(',');
        } else {
            acc[key] = value;
        }
        return acc;
    }, {});
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91cGxvYWRzL2dldEV4dGVybmFsRmlsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFJlcXVlc3QgfSBmcm9tICdleHByZXNzJ1xuaW1wb3J0IHR5cGUgeyBJbmNvbWluZ0h0dHBIZWFkZXJzIH0gZnJvbSAnaHR0cCdcblxuaW1wb3J0IHR5cGUgeyBGaWxlLCBGaWxlRGF0YSwgSW5jb21pbmdVcGxvYWRUeXBlIH0gZnJvbSAnLi90eXBlcydcblxuaW1wb3J0IHsgQVBJRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMnXG5cbnR5cGUgQXJncyA9IHtcbiAgZGF0YTogRmlsZURhdGFcbiAgcmVxOiBSZXF1ZXN0XG4gIHVwbG9hZENvbmZpZzogSW5jb21pbmdVcGxvYWRUeXBlXG59XG5leHBvcnQgY29uc3QgZ2V0RXh0ZXJuYWxGaWxlID0gYXN5bmMgKHsgZGF0YSwgcmVxLCB1cGxvYWRDb25maWcgfTogQXJncyk6IFByb21pc2U8RmlsZT4gPT4ge1xuICBjb25zdCB7IGZpbGVuYW1lLCB1cmwgfSA9IGRhdGFcblxuICBpZiAodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpIHtcbiAgICBsZXQgZmlsZVVSTCA9IHVybFxuICAgIGlmICghdXJsLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgICAgY29uc3QgYmFzZVVybCA9IHJlcS5nZXQoJ29yaWdpbicpIHx8IGAke3JlcS5wcm90b2NvbH06Ly8ke3JlcS5nZXQoJ2hvc3QnKX1gXG4gICAgICBmaWxlVVJMID0gYCR7YmFzZVVybH0ke3VybH1gXG4gICAgfVxuXG4gICAgY29uc3QgeyBkZWZhdWx0OiBmZXRjaCB9ID0gKGF3YWl0IGltcG9ydCgnbm9kZS1mZXRjaCcpKSBhcyBhbnlcblxuICAgIGNvbnN0IGhlYWRlcnMgPSB1cGxvYWRDb25maWcuZXh0ZXJuYWxGaWxlSGVhZGVyRmlsdGVyXG4gICAgICA/IHVwbG9hZENvbmZpZy5leHRlcm5hbEZpbGVIZWFkZXJGaWx0ZXIoaGVhZGVyc1RvT2JqZWN0KHJlcS5oZWFkZXJzKSlcbiAgICAgIDoge1xuICAgICAgICAgIGNvb2tpZTogcmVxLmhlYWRlcnNbJ2Nvb2tpZSddLFxuICAgICAgICB9XG5cbiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChmaWxlVVJMLCB7XG4gICAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLFxuICAgICAgaGVhZGVycyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgfSlcblxuICAgIGlmICghcmVzLm9rKSB0aHJvdyBuZXcgQVBJRXJyb3IoYEZhaWxlZCB0byBmZXRjaCBmaWxlIGZyb20gJHtmaWxlVVJMfWAsIHJlcy5zdGF0dXMpXG5cbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmJ1ZmZlcigpXG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogZmlsZW5hbWUsXG4gICAgICBkYXRhLFxuICAgICAgbWltZXR5cGU6IHJlcy5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJykgfHwgdW5kZWZpbmVkLFxuICAgICAgc2l6ZTogTnVtYmVyKHJlcy5oZWFkZXJzLmdldCgnY29udGVudC1sZW5ndGgnKSkgfHwgMCxcbiAgICB9XG4gIH1cblxuICB0aHJvdyBuZXcgQVBJRXJyb3IoJ0ludmFsaWQgZmlsZSB1cmwnLCA0MDApXG59XG5cbmZ1bmN0aW9uIGhlYWRlcnNUb09iamVjdChoZWFkZXJzOiBJbmNvbWluZ0h0dHBIZWFkZXJzKSB7XG4gIHJldHVybiBPYmplY3QuZW50cmllcyhoZWFkZXJzKS5yZWR1Y2UoXG4gICAgKGFjYywgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgYWNjW2tleV0gPSB2YWx1ZS5qb2luKCcsJylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFjY1trZXldID0gdmFsdWVcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFjY1xuICAgIH0sXG4gICAge30gYXMgUmVjb3JkPHN0cmluZywgc3RyaW5nPixcbiAgKVxufVxuIl0sIm5hbWVzIjpbImdldEV4dGVybmFsRmlsZSIsImRhdGEiLCJyZXEiLCJ1cGxvYWRDb25maWciLCJmaWxlbmFtZSIsInVybCIsImZpbGVVUkwiLCJzdGFydHNXaXRoIiwiYmFzZVVybCIsImdldCIsInByb3RvY29sIiwiZGVmYXVsdCIsImZldGNoIiwiaGVhZGVycyIsImV4dGVybmFsRmlsZUhlYWRlckZpbHRlciIsImhlYWRlcnNUb09iamVjdCIsImNvb2tpZSIsInJlcyIsImNyZWRlbnRpYWxzIiwibWV0aG9kIiwib2siLCJBUElFcnJvciIsInN0YXR1cyIsImJ1ZmZlciIsIm5hbWUiLCJtaW1ldHlwZSIsInVuZGVmaW5lZCIsInNpemUiLCJOdW1iZXIiLCJPYmplY3QiLCJlbnRyaWVzIiwicmVkdWNlIiwiYWNjIiwia2V5IiwidmFsdWUiLCJBcnJheSIsImlzQXJyYXkiLCJqb2luIl0sIm1hcHBpbmdzIjoiOzs7OytCQVlhQTs7O2VBQUFBOzs7d0JBUFk7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU9sQixNQUFNQSxrQkFBa0IsT0FBTyxFQUFFQyxJQUFJLEVBQUVDLEdBQUcsRUFBRUMsWUFBWSxFQUFRO0lBQ3JFLE1BQU0sRUFBRUMsUUFBUSxFQUFFQyxHQUFHLEVBQUUsR0FBR0o7SUFFMUIsSUFBSSxPQUFPSSxRQUFRLFVBQVU7UUFDM0IsSUFBSUMsVUFBVUQ7UUFDZCxJQUFJLENBQUNBLElBQUlFLFVBQVUsQ0FBQyxTQUFTO1lBQzNCLE1BQU1DLFVBQVVOLElBQUlPLEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRVAsSUFBSVEsUUFBUSxDQUFDLEdBQUcsRUFBRVIsSUFBSU8sR0FBRyxDQUFDLFFBQVEsQ0FBQztZQUMzRUgsVUFBVSxDQUFDLEVBQUVFLFFBQVEsRUFBRUgsSUFBSSxDQUFDO1FBQzlCO1FBRUEsTUFBTSxFQUFFTSxTQUFTQyxLQUFLLEVBQUUsR0FBSSxNQUFNLG1FQUFBLFFBQU87UUFFekMsTUFBTUMsVUFBVVYsYUFBYVcsd0JBQXdCLEdBQ2pEWCxhQUFhVyx3QkFBd0IsQ0FBQ0MsZ0JBQWdCYixJQUFJVyxPQUFPLEtBQ2pFO1lBQ0VHLFFBQVFkLElBQUlXLE9BQU8sQ0FBQyxTQUFTO1FBQy9CO1FBRUosTUFBTUksTUFBTSxNQUFNTCxNQUFNTixTQUFTO1lBQy9CWSxhQUFhO1lBQ2JMO1lBQ0FNLFFBQVE7UUFDVjtRQUVBLElBQUksQ0FBQ0YsSUFBSUcsRUFBRSxFQUFFLE1BQU0sSUFBSUMsZ0JBQVEsQ0FBQyxDQUFDLDBCQUEwQixFQUFFZixRQUFRLENBQUMsRUFBRVcsSUFBSUssTUFBTTtRQUVsRixNQUFNckIsT0FBTyxNQUFNZ0IsSUFBSU0sTUFBTTtRQUU3QixPQUFPO1lBQ0xDLE1BQU1wQjtZQUNOSDtZQUNBd0IsVUFBVVIsSUFBSUosT0FBTyxDQUFDSixHQUFHLENBQUMsbUJBQW1CaUI7WUFDN0NDLE1BQU1DLE9BQU9YLElBQUlKLE9BQU8sQ0FBQ0osR0FBRyxDQUFDLHNCQUFzQjtRQUNyRDtJQUNGO0lBRUEsTUFBTSxJQUFJWSxnQkFBUSxDQUFDLG9CQUFvQjtBQUN6QztBQUVBLFNBQVNOLGdCQUFnQkYsT0FBNEI7SUFDbkQsT0FBT2dCLE9BQU9DLE9BQU8sQ0FBQ2pCLFNBQVNrQixNQUFNLENBQ25DLENBQUNDLEtBQUssQ0FBQ0MsS0FBS0MsTUFBTTtRQUNoQixJQUFJQyxNQUFNQyxPQUFPLENBQUNGLFFBQVE7WUFDeEJGLEdBQUcsQ0FBQ0MsSUFBSSxHQUFHQyxNQUFNRyxJQUFJLENBQUM7UUFDeEIsT0FBTztZQUNMTCxHQUFHLENBQUNDLElBQUksR0FBR0M7UUFDYjtRQUVBLE9BQU9GO0lBQ1QsR0FDQSxDQUFDO0FBRUwifQ==